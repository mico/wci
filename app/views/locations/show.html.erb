<% lat = @location.data["geometry"]["location"]["lat"]
   lng = @location.data["geometry"]["location"]["lng"]%>
    <script type="text/javascript">
        var map;

        function showevents(location_id) {
            $.ajax({url: '/locations/'+location_id+'/events/'});/*.done(function(data) {
                $('#events').replace(data);
            });*/

        }
        function success(position) {
            //var s = document.querySelector('#status');

            //if (s.className == 'success') {
                // not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back
              //  return;
            //}

            //s.innerHTML = "found you!";
            //s.className = 'success';

            var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            map.setCenter(latlng);
            var marker = new google.maps.Marker({
                position: latlng,
                title:"You are here!"
            });
            marker.setMap(map);

            //var marker = new google.maps.Marker({
            //    position: latlng,
            //    map: map,
            //    title:"You are here! (at least within a "+position.coords.accuracy+" meter radius)"
            //});
            //move map
            //alert(position.coords);
        }

        function error(msg) {
            alert(msg);
        }

        function initialize() {
            var mapOptions = {
                //center: new google.maps.LatLng(<%= lat %>, <%= lng %>),
                zoom: 8
            };
            map = new google.maps.Map(document.getElementById("map"),
                    mapOptions);

            <% @locations.each do |location| %>
            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(<%= location.latitude %>, <%= location.longitude %>),
                title:'<%= location.title %>'
            });
            marker.setMap(map);
            google.maps.event.addListener(marker, 'click', function() {
                showevents(<%= location.id %>);
            });

            <% end %>
            /*function toggleBounce() {

                if (marker.getAnimation() != null) {
                    marker.setAnimation(null);
                } else {
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                }
            }

            google.maps.event.addListener(marker, 'click', toggleBounce);*/


            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                // use # returns Geocoder::Result object
                // result = request.location // RUBY

                error('not supported');
            }


        }

        google.maps.event.addDomListener(window, 'load', initialize);

    </script>

<div style='width: 1400px;'>
  <div id="map" style='width: 1400px; height: 500px;'></div>
</div>

<%= @location.data["geometry"]["location"] %>
<%# image_tag "http://maps.google.com/maps/api/staticmap?size=450x300&sensor=false&zoom=16&markers=#{@location.latitude}%2C#{@location.longitude}" %>

<div id="events">no events</div>

<h3>Nearby locations</h3>
<ul>
<%# for location in @locations.nearbys(10) %>
  <li><%# link_to location.address, location %> (<%#= location.distance.round(2) %> miles)</li>
<%# end %>
</ul>
